#!/bin/sh -e

. $(dirname $0)/environment

# Get the current address
ADDRESS=$(
    curl -s http://ipdetect.dnspark.com/ | \
    grep 'Current Address:' | \
    sed 's/Current Address: //'
)

CONFIG=$(curl \
    -s \
    -H "PddToken: $TOKEN" \
    $BASE_URL/list\?domain=$DOMAIN
)

CURRENT_ADDRESS=$(echo $CONFIG | jq -r '.records[] | select(.type == "A") | .content')

if [ $ADDRESS = $CURRENT_ADDRESS ]
then
    echo "Address is current."
    exit 0
fi

RECORD_ID=$(echo $CONFIG | jq -r '.records[] | select(.type == "A") | .record_id')

# Update the address
curl \
    -s \
    -H "PddToken: $TOKEN" \
    -d "domain=$DOMAIN&record_id=$RECORD_ID&content=$ADDRESS" \
    $BASE_URL/edit
